# Generated by Ansible

### Params
## Interfaces
local_if="lo0"
ext_if="{{ ansible_default_ipv4.device }}"

## Address list
server_addr="{{ ansible_default_ipv4.address }}"

table <whitelist> { {% for ip in ipv4_whitelist %}{{ ip }} {% if loop.last == False %} , {% endif %}{% endfor %} }

table <badguys> persist file "/etc/pf.ban"
table <ssh-bruteforce> persist

include "/etc/pf.further-params.conf"

## Ports
tcp_ports_authorized="{ {% for port in default_tcp_ports_authorized %}{{ port }} {% endfor %}}"

### Rules
# Set
set optimization normal
set block-policy return
set require-order yes
set loginterface $ext_if
set skip on $local_if
include "/etc/pf.further-set.conf"

scrub in all

## Nat
include "/etc/pf.further-nat.conf"

## Filter
block in on $ext_if
pass in inet proto { icmp } 

# Authorize out
pass out quick inet proto { udp, icmp } from $ext_if to any keep state 
pass out quick inet proto tcp 

# Include filter ruleset
include "/etc/pf.further-filter.conf"

# Authorize defaults ports
pass in on $ext_if inet proto tcp from any to any port $tcp_ports_authorized flags any keep state
include "/etc/pf.further-pass.conf"

# SSH Ban on badguys and ssh-bruteforce not whitelist
block in quick on $ext_if from <badguys> to any
block in quick from <ssh-bruteforce> to $server_addr
pass in quick on $ext_if inet proto tcp from ! <whitelist> to any port ssh flags S/SA keep state \
  ( max-src-conn-rate 12/50, overload <ssh-bruteforce> flush global)
